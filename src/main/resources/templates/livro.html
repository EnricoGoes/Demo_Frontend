<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novo Livro</title>
    <link rel="stylesheet" href="/style.css">
</head>

<body>
    <div class="container">
        <h2>informações</h2>
        <form id="formLivro">
            <div class="form-group">
                <label for="titulo">Título:</label>
                <input type="text" id="titulo">
            </div>
            <div class="form-group">
                <label for="autor">Autor:</label>
                <input type="text" id="autor">
            </div>
            <div class="form-group">
                <label for="ano">Ano Publicação:</label>
                <input type="text" id="ano">
            </div>
            <div class="form-group">
                <label for="editora">Editora:</label>
                <input type="text" id="editora">
            </div>
            <div class="form-group">
                <label for="genero">Gênero:</label>
                <select id="genero">
                    <option value="">Selecione um gênero</option>
                </select>
            </div>
            <div class="form-group">
                <label for="isbn">ISBN:</label>
                <input type="text" id="isbn">
            </div>
            <div class="form-group">
                <label for="paginas">Nº Páginas:</label>
                <input type="text" id="paginas">
            </div>
            <div class="form-group">
                <label for="idioma">Idioma:</label>
                <input type="text" id="idioma">
            </div>
            <div class="form-group">
                <label for="data">Data Cadastro:</label>
                <input type="text" id="data">
            </div>
            <div class="form-group">
                <label for="preco">Preço:</label>
                <input type="text" id="preco">
            </div>
            <div class="form-group">
                <label for="sinopse">Sinopse:</label>
                <textarea id="sinopse"></textarea>
            </div>
            <div class="buttons">
                <button type="button" class="btn-salvar" id="btnSalvar">Salvar</button>
                <button type="button" class="btn-voltar" onclick="window.location.href='/'">Voltar</button>
            </div>
        </form>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", async function () {
            const params = new URLSearchParams(window.location.search);
            const id = params.get("id");
            const modo = params.get("modo");
            const API_URL = "http://localhost:8081/livro";

            await getGeneros();

            async function getGeneros() {
                try {
                    const response = await fetch("http://localhost:8081/genero/listall");
                    const generos = await response.json();
                    console.log("Gêneros:", generos);

                    const selectGenero = document.getElementById("genero");
                    generos.forEach(genero => {
                        const option = document.createElement("option");
                        option.value = genero.id;
                        option.textContent = genero.nome;
                        selectGenero.appendChild(option);
                    });
                } catch (error) {
                    console.error("Erro ao buscar os gêneros:", error);
                }
            }

            async function cadastrarLivro() {
                const livro = {
                    titulo: document.getElementById("titulo").value,
                    autor: document.getElementById("autor").value,
                    anoPublicacao: document.getElementById("ano").value,
                    editora: document.getElementById("editora").value,
                    genero: { id: document.getElementById("genero").value },
                    isbn: document.getElementById("isbn").value,
                    numPaginas: document.getElementById("paginas").value,
                    idioma: document.getElementById("idioma").value,
                    dataCadastro: document.getElementById("data").value,
                    preco: document.getElementById("preco").value,
                    sinopse: document.getElementById("sinopse").value
                };

                try {
                    const response = await fetch(API_URL, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(livro)
                    });

                    if (response.ok) {
                        alert("Livro cadastrado com sucesso!");
                        window.location.href = "/";
                    } else {
                        console.error("Erro ao cadastrar livro:", response.status);
                    }
                } catch (error) {
                    console.error("Erro ao cadastrar livro:", error);
                }
            }

            async function atualizarLivro() {
                const livro = {
                    titulo: document.getElementById("titulo").value,
                    autor: document.getElementById("autor").value,
                    anoPublicacao: document.getElementById("ano").value,
                    editora: document.getElementById("editora").value,
                    genero: { id: document.getElementById("genero").value },
                    isbn: document.getElementById("isbn").value,
                    numPaginas: document.getElementById("paginas").value,
                    idioma: document.getElementById("idioma").value,
                    dataCadastro: document.getElementById("data").value,
                    preco: document.getElementById("preco").value,
                    sinopse: document.getElementById("sinopse").value
                };

                try {
                    const response = await fetch(`${API_URL}/${id}`, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(livro)
                    });

                    if (response.ok) {
                        alert("Livro atualizado com sucesso!");
                        window.location.href = "/";
                    } else {
                        console.error("Erro ao atualizar livro:", response.status);
                    }
                } catch (error) {
                    console.error("Erro ao atualizar livro:", error);
                }
            }

            async function getLivro(id) {
                try {
                    const response = await fetch(`${API_URL}/${id}`);
                    if (!response.ok) throw new Error("Erro ao buscar livro");

                    const livro = await response.json();
                    console.log("Dados do Livro:", livro);

                    document.getElementById("titulo").value = livro.titulo;
                    document.getElementById("autor").value = livro.autor;
                    document.getElementById("ano").value = livro.anoPublicacao;
                    document.getElementById("editora").value = livro.editora;
                    document.getElementById("genero").value = livro.genero.id;
                    document.getElementById("isbn").value = livro.isbn;
                    document.getElementById("paginas").value = livro.numPaginas;
                    document.getElementById("idioma").value = livro.idioma;
                    document.getElementById("preco").value = livro.preco;
                    document.getElementById("sinopse").value = livro.sinopse;
                    document.getElementById("data").value = livro.dataCadastro;

                } catch (error) {
                    console.error("Erro ao buscar o livro:", error);
                }
            }

            document.getElementById("btnSalvar").addEventListener("click", async function () {
                if (id) {
                    await atualizarLivro();
                } else {
                    await cadastrarLivro();
                }
            });

            if (id) {
                await getLivro(id);
            }

            if (modo === "visualizar") {
                document.querySelectorAll("input, select, textarea").forEach((item) => {
                    item.setAttribute("readonly", true);
                    item.setAttribute("disabled", true);
                });
                document.getElementById("btnSalvar").style.display = "none"; // Esconde botão de salvar
            }
        });
    </script>

</body>

</html>